readLines("plop.txt")
readLines("plop.txt") -> z
length(z)
l1_mhm
export_spatraster_grid <- function(x, filename, signif = NULL, ...){
# Get number of layers
nlayers <- terra::nlyr(x)
# Open file connection
con <- file(filename, "w")
for(i in 1:nlayers){
layer <- x[[i]]
layer_name <- terra::names(x)[i]
# Write layer name separator (only for multiple layers)
if(nlayers > 1){
if(i > 1) writeLines("", con)  # blank line before layer
writeLines(paste("###", layer_name), con)
}
# Convert layer to matrix and write
mat <- terra::as.matrix(layer, wide = TRUE)
# Round to significant digits if specified
if(!is.null(signif)) mat <- signif(mat, digits = signif)
write.table(mat,
file = con,
row.names = FALSE, col.names = FALSE,
sep = " ", ...)
}
close(con)
}
export_spatraster_grid(l1_mhm, "plop2.txt", signif = 4)
export_spatraster_grid <- function(x, filename, signif = NULL, ...){
# Get number of layers
nlayers <- terra::nlyr(x)
# Open file connection
con <- file(filename, "w")
for(i in 1:nlayers){
layer <- x[[i]]
layer_name <- names(x)[i]
# Write layer name separator (only for multiple layers)
if(nlayers > 1){
if(i > 1) writeLines("", con)  # blank line before layer
writeLines(paste("###", layer_name), con)
}
# Convert layer to matrix and write
mat <- terra::as.matrix(layer, wide = TRUE)
# Round to significant digits if specified
if(!is.null(signif)) mat <- signif(mat, digits = signif)
write.table(mat,
file = con,
row.names = FALSE, col.names = FALSE,
sep = " ", ...)
}
close(con)
}
export_spatraster_grid(l1_mhm, "plop2.txt", signif = 4)
export_spatraster_grid(l1_mhm[[1]], "plop3.txt", signif = 4)
import_spatraster_grid <- function(filename){
# Read file as text
lines <- readLines(filename)
# Identify layer separators (lines starting with ###)
sep_idx <- grep("^###", lines)
if(length(sep_idx) == 0){
# Single layer: no headers
mat <- as.matrix(read.table(filename))
layer_names <- "layer"
mats <- list(mat)
} else {
# Multiple layers: extract names and data
layer_names <- sub("^### ", "", lines[sep_idx])
mats <- list()
for(i in seq_along(sep_idx)){
# Get start and end row indices for each layer
start_row <- sep_idx[i] + 1
end_row <- ifelse(i < length(sep_idx), sep_idx[i+1] - 2, length(lines))
# Read layer data
layer_lines <- lines[start_row:end_row]
layer_lines <- layer_lines[layer_lines != ""]  # remove blank lines
# Convert to matrix
con <- textConnection(paste(layer_lines, collapse = "\n"))
mat <- as.matrix(read.table(con))
close(con)
mats[[i]] <- mat
}
}
# Stack all layers into a single array
stacked <- do.call(terra::c,
lapply(mats, function(m) terra::rast(m)))
# Set layer names
names(stacked) <- layer_names
return(stacked)
}
yop <-import_spatraster_grid("plop2.txt")
import_spatraster_grid <- function(filename){
# Read file as text
lines <- readLines(filename)
# Identify layer separators (lines starting with ###)
sep_idx <- grep("^###", lines)
if(length(sep_idx) == 0){
# Single layer: no headers
mat <- as.matrix(read.table(filename))
layer_names <- "layer"
mats <- list(mat)
} else {
# Multiple layers: extract names and data
layer_names <- sub("^### ", "", lines[sep_idx])
mats <- list()
for(i in seq_along(sep_idx)){
# Get start and end row indices for each layer
start_row <- sep_idx[i] + 1
end_row <- ifelse(i < length(sep_idx), sep_idx[i+1] - 2, length(lines))
# Read layer data
layer_lines <- lines[start_row:end_row]
layer_lines <- layer_lines[layer_lines != ""]  # remove blank lines
# Convert to matrix
con <- textConnection(paste(layer_lines, collapse = "\n"))
mat <- as.matrix(read.table(con))
close(con)
mats[[i]] <- mat
}
}
# Stack all layers into a single array
stacked <- do.call(c,
lapply(mats, function(m) terra::rast(m)))
# Set layer names
names(stacked) <- layer_names
return(stacked)
}
yop <-import_spatraster_grid("plop2.txt")
yop
yop %>% p()
yop %>% app(mean) %>% p()
yop %>% app(mean) %>% MHM(fun=mean, w=3) %>% p()
yop %>% p()
l1_mhm %>% export_spatraster_grid("ignore/mhm_evenness.txt")
l12_cmp_cor %>% export_spatraster_grid("ignore/cmp_cor.txt")
l12_cmp_euc %>% export_spatraster_grid("ignore/cmp_euc.txt")
import_txt("ignore/legacy_data/Even_multiScales/average.txt", na="-9999")
import_txt("ignore/legacy_data/Even_multiScales/average.txt", na=-9999) %>%
p
import_txt("ignore/legacy_data/Even_multiScales/average.txt", na=-9999) -> l1_mhm_legacy
l1_mhm_legacy %>% raster_declareNA("-9999") %>% p()
l1_mhm_legacy %>% raster_declareNA(-9999) %>% p()
l1_mhm_legacy %>% raster_declareNA(-9999.0) %>% p()
l1_mhm_legacy
import_txt("ignore/legacy_data/Even_multiScales/average.txt", na="-9999.0", sep="  ") -> l1_mhm_legacy
readLines("ignore/legacy_data/Even_multiScales/average.txt") %>%
stringr::str_replace("  ", " ") %>%
read.table(text=., sep=" ", na.stringes="-9999.0") %>%
terra::rast() %>% p()
readLines("ignore/legacy_data/Even_multiScales/average.txt") %>%
stringr::str_replace("  ", " ") %>%
read.table(text=., sep=" ", na.strings="-9999.0") %>%
terra::rast() %>% p()
read.table("ignore/legacy_data/Even_multiScales/average.txt", sep=" +")
read.delim("ignore/legacy_data/Even_multiScales/average.txt", sep=" +")
read.delim("ignore/legacy_data/Even_multiScales/average.txt", sep=" ")
read.delim("ignore/legacy_data/Even_multiScales/average.txt", sep=" ", h=F)
read.delim("ignore/legacy_data/Even_multiScales/average.txt", sep=" ", h=F) %>%
terra::rast()
readLines("ignore/legacy_data/Even_multiScales/average.txt") %>%
stringr::str_replace(" +", " ") %>%
read.table(text=., sep=" ", h=F, na.strings="-9999.0") %>%
terra::rast() %>% p()
readLines("ignore/legacy_data/Even_multiScales/average.txt") %>%
stringr::str_replace(" +", " ") %>%
read.table(text=., sep=" ", h=F) %>%
terra::rast() %>% p()
readLines("ignore/legacy_data/Even_multiScales/average.txt") %>%
stringr::str_replace(" +", " ") %>%
read.table(text=., sep=" ", h=F) -> z
z
dim(z)
z[1, ]
z[1, 1:30]
readLines("ignore/legacy_data/Even_multiScales/average.txt") %>%
stringr::str_replace(" +", " ") -> z
z[1:2, 1:30]
z
z[1:2]
z[1:2] %>% stringr::str_replace(" +", " ")
z[1:2] %>%
stringr::str_replace(" +", " ") %>%
stringr::str_replace("-9999.0", "NA")
z[1:2] %>%
stringr::str_replace_all(" +", " ") %>%
stringr::str_replace_all("-9999.0", "NA")
readLines("ignore/legacy_data/Even_multiScales/average.txt") %>%
stringr::str_replace_all(" +", " ") %>%
stringr::str_replace_all("-9999.0", "NA") %>%
read.table(text=., sep=" ", h=F) %>%
terra::rast() %>% p()
readLines("ignore/legacy_data/Even_multiScales/average.txt") %>%
stringr::str_replace_all(" +", " ") %>%
stringr::str_replace_all("-9999.0", "NA") %>%
read.table(text=., sep=" ", h=F) -> z
dim(z)
z[1:3, 1:20]
z %>% terra::rast()
tail(z)
z %>% as.matrix() %>% terra::rast()
z %>% as.matrix() %>% terra::rast() %>% p
readLines("ignore/legacy_data/Even_multiScales/average.txt") %>%
gsub(" +", " ", .) %>%
gsub("-9999.0", "NA", .) %>%
utils::read.table(text=., sep=" ", header=F)  %>%
as.matrix() %>%
terra::rast() %>% p()
dev.off()
readLines("ignore/legacy_data/Even_multiScales/average.txt") %>%
gsub(" +", " ", .) %>%
gsub("-9999.0", "NA", .) %>%
utils::read.table(text=., sep=" ", header=F)  %>%
as.matrix() %>%
terra::rast() %>% p()
?readLines
readLines("ignore/legacy_data/Even_multiScales/average.txt") %>%
gsub(" +", " ", .) %>%
gsub("-9999.0", "NA", .) %>%
import_text(text=.)
readLines("ignore/legacy_data/Even_multiScales/average.txt") %>%
gsub(" +", " ", .) %>%
gsub("-9999.0", "NA", .) %>%
import_txt(text=.)
devtools::load_all(".")
mhm_eveness_mucha <- import_txt_grid("mhm_evenness.txt")
mhm_eveness_mucha %>% p
import_legacy <- function(x){
x %>% readLines() %>%
gsub(" +", " ", .) %>%
gsub("-9999.0", "NA", .) %>%
utils::read.table(text=., sep=" ", header=F)  %>%
as.matrix() %>%
terra::rast()
}
import_legacy <- function(x){
x %>% readLines() %>%
gsub(" +", " ", .) %>%
gsub("-9999.0", "NA", .) %>%
utils::read.table(text=., sep=" ", header=F)  %>%
as.matrix() %>%
terra::rast()
}
mhm_eveness_legacy <- import_legacy("legacy_data/Even_multiScales/average.txt")
cmp_cor_legacy     <- import_legacy("legacy_data/Corr_multiScales/average.txt")
cmp_dist_legacy    <- import_legacy("legacy_data/Dist_multiScales/average.txt")
c("mucha"=mhm_eveness_mucha, "legacy"=mhm_eveness_legacy) %>% p()
mhm_eveness_mucha
mhm_eveness_mucha <- app(mhm_eveness_mucha_mono, mean)
mhm_eveness_mucha_mono <- import_txt_grid("mhm_evenness.txt")
cmp_cor_mucha_mono     <- import_txt_grid("cmp_cor.txt")
cmp_dist_mucha_mono    <- import_txt_grid("cmp_euc.txt")
mhm_eveness_mucha <- app(mhm_eveness_mucha_mono, mean)
cmp_cor_mucha     <- app(cmp_cor_mucha_mono, mean)
cmp_dist_mucha    <- app(cmp_dist_mucha_mono, mean)
import_legacy <- function(x){
x %>%
readLines() %>%
gsub(" +", " ", .) %>%
gsub("-9999.0", "NA", .) %>%
utils::read.table(text=., sep=" ", header=F)  %>%
as.matrix() %>%
terra::rast()
}
mhm_eveness_legacy <- import_legacy("legacy_data/Even_multiScales/average.txt")
cmp_cor_legacy     <- import_legacy("legacy_data/Corr_multiScales/average.txt")
cmp_dist_legacy    <- import_legacy("legacy_data/Dist_multiScales/average.txt")
c("mucha"=mhm_eveness_mucha, "legacy"=mhm_eveness_legacy) %>% p()
mhm_eveness_mucha %>% p()
mhm_eveness_legacy %>% p()
mhm_eveness_mucha %>% p()
mhm_eveness_legacy %>% p()
rescale_spatraster <- function(x, new_min = 0, new_max = 255){
# Get current min and max for each layer
minmax <- terra::minmax(x)
old_min <- minmax[1, ]
old_max <- minmax[2, ]
# Rescale using linear transformation
# new_val = (old_val - old_min) / (old_max - old_min) * (new_max - new_min) + new_min
rescaled <- terra::app(x, function(v) {
for(i in seq_len(ncol(v))){
col <- v[, i]
v[, i] <- (col - old_min[i]) / (old_max[i] - old_min[i]) *
(new_max - new_min) + new_min
}
v
})
return(rescaled)
}
raster_rescale <- function(x, new_min = 0, new_max = 255){
# Get current min and max for each layer
minmax <- terra::minmax(x)
old_min <- minmax[1, ]
old_max <- minmax[2, ]
# Rescale using linear transformation
# new_val = (old_val - old_min) / (old_max - old_min) * (new_max - new_min) + new_min
rescaled <- terra::app(x, function(v) {
for(i in seq_len(ncol(v))){
col <- v[, i]
v[, i] <- (col - old_min[i]) / (old_max[i] - old_min[i]) *
(new_max - new_min) + new_min
}
v
})
return(rescaled)
}
mhm_eveness_legacy %>% raster_rescale() %>% p
mhm_eveness_legacy %>% terra::minmax()
mhm_eveness_mucha %>% raster_rescale() %>% p
mhm_eveness_legacy %>% terra::minmax()
mhm_eveness_legacy %>% raster_rescale() %>% p
mhm_eveness_legacy %>% raster_rescale() %>% minmax()
mhm_eveness_mucha %>% raster_rescale() %>% minmax()
c(mhm_eveness_mucha, mhm_eveness_legacy)
mhm_eveness_mucha %>% raster_rescale() %>% p()
mhm_eveness_mucha %>% p()
l1 %>% p()
c(l1, mhm_eveness_mucha) %>% p
par(mfcol=c(2, 1))
l1 %>% p()
mhm_eveness_mucha %>% p
p(l1, main="plop")
devtools::load_all(".")
p(l1)
# mhm_eveness_mucha, "legacy"=mhm_eveness_legacy) %>% p()
p(l1, title="original")
# mhm_eveness_mucha, "legacy"=mhm_eveness_legacy) %>% p()
source("~/Research/mucha/R/gr.R")
p(l1, title="original")
devtools::load_all(".")
p(l1, title="original")
#' @examples
#' # first calculate a small and simple MHM
#' l <- import_example("l1.tif") %>%
#' raster_resample(0.1) %>%
#' MHM(window=c(3, 13, 23, 33), fun=richness)
#'
#' # then let the fun begins
#' p(l) # compare with plot(l)
#' p(l, palette = "RdYlBu", ncol=1)
#' @export
p <- function(x, palette = "viridis", asp=1, ncol = NULL, title, ...) {
# calculate colors
if(is.character(palette) && length(palette)==1) {
cols <- grDevices::hcl.colors(100, palette)
} else {
cols <- palette
}
# simple heuristic for layout-ing
# aim for asp is ncol is not provided
n_layers <- terra::nlyr(x)
# handles title
if (missing(title))
main <- names(x)
else
main <- rep(title, n_layers)
# to handle single plot case
if (n_layers==1){
# first layer will have a legend
terra::plot(x, legend = TRUE,
col = cols, main = main,  ...)
} else {
# calculate a global range accross all layers
global_range <- range(terra::values(x), na.rm = TRUE)
if(is.null(ncol)) {
ncol <- ceiling(sqrt(n_layers * asp))
}
# now we have an ncol either through asp or if provided
nrow <- ceiling(n_layers / ncol)
# build and pass the layout
layout_mat <- matrix(1:(nrow * ncol), nrow = nrow, ncol = ncol, byrow = TRUE)
layout(layout_mat,
widths = rep(1, ncol),
heights = rep(1, nrow))
# first layer will have a legend
terra::plot(x[[1]], range = global_range, legend = TRUE,
col = cols, main = main,  ...)
# others nope
for(i in 2:n_layers) {
terra::plot(x[[i]], range = global_range, legend = FALSE,
col = cols, main = main,  ...)
}
# reset layout to stay friend with evryone
graphics::layout(1)
}
}
p(l1, title="original")
values(mhm_eveness_mucha)
values(mhm_eveness_mucha) %>% as.numeric() %>% na.omit() %>% hist()
values(mhm_eveness_legacy) %>% as.numeric() %>% na.omit() %>% hist()
values(mhm_eveness_mucha) %>% as.numeric() %>% na.omit() %>% hist()
app(mhm_eveness_mucha_mono, prod) %>% p()
mhm_eveness_legacy %>% p()
values(mhm_eveness_legacy) %>% as.numeric() %>% na.omit() %>% hist()
values(app(mhm_eveness_mucha_mono, prod)) %>% as.numeric() %>% na.omit() %>% hist()
values(app(mhm_eveness_mucha_mono, gmean)) %>% as.numeric() %>% na.omit() %>% hist()
values(mhm_eveness_legacy) %>% as.numeric() %>% na.omit() %>% hist()
app(mhm_eveness_mucha_mono, prod) %>% p()
app(mhm_eveness_mucha_mono, gmean) %>% p()
t0_mhm <- Sys.time()
l1_mhm <- MHM(l1, window = 90, fun=contagion); t1_mhm <- Sys.time() - t0_mhm
l1_mhm <- MHM(l1, window = 89, fun=contagion); t1_mhm <- Sys.time() - t0_mhm
p(c(l1, l2), title="original")
p(cmp_dist_mucha, main="mucha euc dist")
p(cmp_dist_mucha, main="mucha euc dist")
p(cmp_dist_mucha, title="mucha euc dist")
p(cmp_dist_legacy, title="legacy euc dist eveness")
p(app(cmp_dist_mucha_mono, prod), title="mucha euc dist")
devtools::load_all(".")
library(terra)
# import the first example file
l1 <- import_example("l1.tif")
# and the second
l2 <- import_example("l2.tif")
# we can plot them side by side
c(l1, l2) %>% p()
# make them smaller by a factor 10 for example purpose
ls1 <- raster_resample(l1, 0.1)
ls2 <- raster_resample(l2, 0.1)
ls_cmp <- CMP(ls1, ls2,
window=seq(3, 13, by=2),
fun=diff_rmse)
p(ls_cmp)
ms_profile(ls_cmp)
app(ls_cmp, mean) %>% p()
ms_profile
ms_profile_df
ms_profile
ms_profile_df
pak::pak("vbonhomme/mucha")
install.packages("pak")
pak::pak("vbonhomme/mucha")
pkgdown::build_home()
pkgdown::preview_site(path='index.html')
pkgdown::build_home()
mhm_eveness_mucha_mono <- import_txt_grid("mhm_evenness.txt")
cmp_cor_mucha_mono     <- import_txt_grid("cmp_cor.txt")
cmp_dist_mucha_mono    <- import_txt_grid("cmp_euc.txt")
cmp_cor_mucha_mono %>%
p
cmp_cor_mucha_mono %>% p
cmp_cor_mucha_mono     <- import_txt_grid("cmp_cor.txt")
cmp_cor_mucha_mono %>% p
vignette("intro", "mucha")
vignette(pack="mucha")
vignette("mucha tutorial", pack="mucha")
vignette("mucha manual", pack="mucha")
vignette("mucha manual", package="mucha")
vignette(topic="mucha manual", package="mucha")
vignette("mucha manual", package="mucha")
devtools::load_all(".")
vignette("mucha manual", package="mucha")
vignette(mucha manual, package="mucha")
devtools::load_all(".")
vignette("manual", package="mucha")
devtools::load_all(".")
vignette("manual", package="mucha")
vignette("intro", package="mucha")
devtools::load_all(".")
#' library(terra)
#'
#' # import an example file
#' # and turn it into a SpatRaster
#' landscape <- import_example("l1.tif")
#'
#' # plot it
#' plot(landscape)
#'
#' # make it smaller for example purpose:
#' l0 <- landscape %>% raster_resample(0.1)
#'
#' # plot the little landscape
#' p(l0)
#'
#' # calculate MHM on it
#' l0_mhm <- MHM(l0,
#'               window=seq(2, 13, by=2)+1,
#'               fun=shannon_evenness)
#'
#' # display all intermediate maps
#' p(l0_mhm)
#'
#' # the profile plot
#' ms_profile(l0_mhm)
#'
#' # and a synthetic map
#' app(l0_mhm,  median) %>% p()
#' app(l0_mhm,  sd) %>% p()
#'
#' # change the color palette and print side by side
#' l0_sd <- app(l0_mhm,  sd)
#' c(l0, l0_sd) %>%
#' p("Kottoli raw", "Kottoli composite")
#' c(l0, l0_sd) %>%
#' p(title="Kottoli")
c(l0, l0_sd) %>% p("Kottoli raw", "Kottoli composite")
c(l0, l0_sd) %>% p(title=c("Kottoli raw", "Kottoli composite"))
c(l0, l0_sd) %>% p(title=c("Kottoli raw"))
c(l0, l0_sd) %>% p()
l0
library(terra)
# import an example file
# and turn it into a SpatRaster
landscape <- import_example("l1.tif")
# plot it
plot(landscape)
# make it smaller for example purpose:
l0 <- landscape %>% raster_resample(0.1)
# plot the little landscape
p(l0)
# calculate MHM on it
l0_mhm <- MHM(l0,
window=seq(2, 13, by=2)+1,
fun=shannon_evenness)
